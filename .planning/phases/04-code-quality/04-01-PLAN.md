---
phase: 04-code-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/js/main.js
autonomous: true

must_haves:
  truths:
    - "Scroll handler fires at most once per 16ms (60fps throttle)"
    - "No memory leaks from document-level event listeners"
    - "Popup drag functionality still works correctly"
  artifacts:
    - path: "assets/js/main.js"
      provides: "Throttled scroll handler and cleaned up event listeners"
      contains: "throttle"
  key_links:
    - from: "toggleScrolled"
      to: "scroll event"
      via: "throttle wrapper"
      pattern: "throttle\\(toggleScrolled"
---

<objective>
Fix JavaScript memory leaks and add throttle to scroll handlers.

Purpose: Improve runtime performance and prevent memory accumulation from leaked event listeners.
Output: Cleaner main.js with throttled scroll handling and proper event cleanup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@assets/js/main.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add throttle utility and apply to scroll handler</name>
  <files>assets/js/main.js</files>
  <action>
    Add a simple throttle utility function at the top of the IIFE (after "use strict"):

    ```javascript
    function throttle(func, limit) {
      let inThrottle;
      return function(...args) {
        if (!inThrottle) {
          func.apply(this, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      };
    }
    ```

    Then wrap the scroll event listener (around line 15) to use throttle:
    - Change `document.addEventListener('scroll', toggleScrolled);`
    - To `document.addEventListener('scroll', throttle(toggleScrolled, 16));`

    16ms = ~60fps, which is optimal for scroll performance.

    Do NOT use lodash or external libraries - this is a static site with no npm.
  </action>
  <verify>Open browser DevTools, scroll rapidly, confirm no performance jank and header class toggles smoothly</verify>
  <done>Scroll handler is throttled at 60fps, scrolling feels smooth</done>
</task>

<task type="auto">
  <name>Task 2: Fix document-level event listener memory leaks</name>
  <files>assets/js/main.js</files>
  <action>
    Fix the popup drag functionality (around lines 403-418) which adds document-level listeners that are never removed:

    Current problem:
    ```javascript
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);
    ```
    These listeners persist even after popup is closed.

    Solution - modify dragEnd to clean up:
    ```javascript
    function dragEnd() {
      if (isDragging) {
        isDragging = false;
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', dragEnd);
      }
    }
    ```

    And move the document listeners to dragStart instead of being added immediately:
    ```javascript
    function dragStart(e) {
      initialX = e.clientX - xOffset;
      initialY = e.clientY - yOffset;

      if (e.target === popupContent || e.target.classList.contains('balloon-header')) {
        isDragging = true;
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);
      }
    }
    ```

    Remove the existing document.addEventListener lines (around 405-406) that add these globally.

    This ensures listeners are only active during drag operations and cleaned up after.
  </action>
  <verify>Open DevTools > Performance > Memory, drag popup multiple times, confirm no listener accumulation</verify>
  <done>Document listeners are added on dragStart, removed on dragEnd - no memory leaks</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Site loads without JavaScript errors (check console)
- [ ] Scroll-triggered header class toggle works correctly
- [ ] Popup drag functionality works on desktop
- [ ] No new console errors introduced
</verification>

<success_criteria>

- All tasks completed
- Throttle function added and applied to scroll handler
- Document event listeners properly managed (add on start, remove on end)
- No regression in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality/04-01-SUMMARY.md`
</output>
