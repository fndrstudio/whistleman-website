---
phase: 04-code-quality
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/js/main.js
  - index.html
  - services.html
  - portfolio.html
  - contact.html
  - portfolio/burgernshake.html
  - portfolio/oeuf.html
  - portfolio/locals.html
  - portfolio/inner circle.html
  - portfolio/linguini.html
  - portfolio/pazzi.html
  - portfolio/l'OUI.html
autonomous: true

must_haves:
  truths:
    - "Error messages display without XSS vulnerability"
    - "Fonts load without blocking page render"
    - "Page text is visible immediately (no FOIT)"
  artifacts:
    - path: "assets/js/main.js"
      provides: "Safe DOM manipulation without innerHTML for user content"
      contains: "textContent"
    - path: "index.html"
      provides: "Non-blocking font loading"
      contains: "font-display=swap"
  key_links:
    - from: "showError function"
      to: "error display"
      via: "textContent instead of innerHTML"
      pattern: "textContent.*=.*message"
---

<objective>
Fix XSS vulnerabilities and optimize Google Fonts loading.

Purpose: Prevent potential security issues from innerHTML usage and improve perceived load time by making fonts non-render-blocking.
Output: Secure error handling and optimized font loading across all HTML pages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@assets/js/main.js
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace innerHTML with safe DOM manipulation</name>
  <files>assets/js/main.js</files>
  <action>
    Fix the showError function (around lines 326-360) which uses innerHTML with user-provided message:

    Current vulnerable code:
    ```javascript
    errorDiv.innerHTML = `
        <div style="...">
            <i class="fas fa-exclamation-circle"></i> ${message}
        </div>
    `;
    ```

    Replace with safe DOM creation:
    ```javascript
    function showError(message) {
      // Remove any existing errors first
      const existingError = document.querySelector('.form-error');
      if (existingError) {
        existingError.remove();
      }

      // Create error display using safe DOM methods
      const errorDiv = document.createElement('div');
      errorDiv.className = 'form-error';

      const innerDiv = document.createElement('div');
      innerDiv.style.cssText = 'background: #ffebee; color: #c62828; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #c62828; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;';

      const icon = document.createElement('i');
      icon.className = 'fas fa-exclamation-circle';

      const text = document.createElement('span');
      text.textContent = message;  // Safe: textContent escapes HTML

      innerDiv.appendChild(icon);
      innerDiv.appendChild(text);
      errorDiv.appendChild(innerDiv);

      // Insert error at the top of the form
      if (downloadForm.firstChild) {
        downloadForm.insertBefore(errorDiv, downloadForm.firstChild);
      } else {
        downloadForm.appendChild(errorDiv);
      }

      // Add animation
      errorDiv.style.animation = 'slideDown 0.3s ease';

      // Auto-remove error after 5 seconds
      setTimeout(() => {
        if (errorDiv.parentNode) {
          errorDiv.remove();
        }
      }, 5000);
    }
    ```

    Note: The other innerHTML usages (submitBtn.innerHTML for spinner, styleSheet.innerHTML for CSS) are SAFE because they use hardcoded strings, not user input. Leave those unchanged.
  </action>
  <verify>Test form submission with invalid input, confirm error displays correctly without HTML interpretation</verify>
  <done>showError function uses textContent for message, preventing XSS</done>
</task>

<task type="auto">
  <name>Task 2: Optimize Google Fonts loading</name>
  <files>index.html, services.html, portfolio.html, contact.html, portfolio/burgernshake.html, portfolio/oeuf.html, portfolio/locals.html, portfolio/inner circle.html, portfolio/linguini.html, portfolio/pazzi.html, portfolio/l'OUI.html</files>
  <action>
    In ALL 11 HTML files, optimize the Google Fonts loading:

    Current (render-blocking):
    ```html
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Bree+Serif:wght@400&display=swap" rel="stylesheet">
    ```

    Optimized (non-blocking + reduced weights):
    ```html
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&family=Bree+Serif&display=swap">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&family=Bree+Serif&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&family=Bree+Serif&display=swap" rel="stylesheet"></noscript>
    ```

    Changes:
    1. Reduced font weights from all 18 (100-900) to just 4 used ones (400, 500, 600, 700)
    2. Removed italic variants (not used in the design)
    3. Added preload for faster font discovery
    4. Made stylesheet non-blocking with media="print" onload trick
    5. Added noscript fallback for users without JS

    This reduces the fonts CSS from ~200KB to ~50KB and makes it non-render-blocking.
  </action>
  <verify>Run Lighthouse audit, confirm fonts no longer listed as render-blocking resources</verify>
  <done>All 11 HTML files have optimized, non-blocking font loading with reduced weights</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Site loads without JavaScript errors
- [ ] Form error messages display correctly (test with empty submission)
- [ ] All pages render text immediately (no flash of invisible text)
- [ ] Fonts load correctly after page load
- [ ] No visual regression in typography
</verification>

<success_criteria>

- All tasks completed
- innerHTML replaced with textContent for user-provided content
- All 11 HTML files updated with optimized font loading
- No security warnings, no render-blocking font resources
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality/04-02-SUMMARY.md`
</output>
